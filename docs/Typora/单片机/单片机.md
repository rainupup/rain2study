# 中断系统

注意：中断系统为软硬件结合

**概念：** 

* CPU在处理某一事件A时，发生的另外某一事件B请求CPU去处理（产生了中断），随后CPU暂时中断当前正在执行的任务，去对事件B进行处理，CPU处理完事件B后再返回之前中断的位置继续执行原来的事件A，这一过程总称为中断。
* 引起CPU中断的根源，称为中断源。中断源向CPU提出的中断请求。CPU暂时中断原来的事务A，转去处理事件B。对事件B处理完毕后，再回到原来被中断的地方（即断点），称为中断返回。实现上述中断功能的部件称为中断系统。
* 89C51/52的中断系统有**5**个中断源 ，**2**个优先级，可实现二级中断嵌套 

## 中断系统结构

![image-20221017171635630](单片机.assets/image-20221017171635630.png)

1.外部中断0(INT0 P3.2) 由 IT0(TCON.0) 选择其为低电平(0)有效还是下降沿(1)有效。当CPU检测到P3.2引脚上出现有效的中断信号时，中断标志IE0(TCON.1)置1，向CPU申请中断。

2.外部中断1(INT1 P3.3） 由 IT1(TCON.2) 选择其为低电平(0)有效还是下降沿(1)有效。当CPU检测到P3.3引脚上出现有效的中断信号时，中断标志IE1(TCON.3)置1,向CPU申请中断。

3.定时/计数器0(T0) TF0（TCON.5），片内定时/计数器T0溢出中断请求标志。当定时/计数器T0发生溢出时，置位TF0，并向CPU申请中断。

4.定时/计数器1(T1) TF1（TCON.7），片内定时/计数器T1溢出中断请求标志。当定时/计数器T1发生溢出时，置位TF1，并向CPU申请中断。

5.RI（SCON.0）或 TI（SCON.1），串行口中断请求标志。当串行口接收完一帧串行数据时置位RI或当串行口发送完一帧串行数据时置位TI，向CPU申请中断。



## 中断源

中断源数量和种类越多，MCU处理突发事件的能力就越强。80C51单片机共有5种中断源。

| 中断源名称   | 中断源符号 | 中断起因                               | 中断入口地址 | 中断号 |
| ------------ | ---------- | -------------------------------------- | ------------ | ------ |
| 外部中断0    | INT0       | P3.2引脚低电平或下降沿信号             | 0003H        | 0      |
| 定时/计数器0 | T0         | 定时/计数器0接收的脉冲数达到溢出程度后 | 000BH        | 1      |
| 外部中断1    | INT1       | P3.3引脚低电平或下降沿信号             | 0013H        | 2      |
| 定时/计数器1 | T1         | 定时/计数器1接收的脉冲数达到溢出程度后 | 001BH        | 3      |
| 串行口中断   | TI/RI      | 一帧串行数据被发送/接收后              | 0023H        | 4      |

优先级别：INT0、T0、INT1、T1、TI/RI



## 中断请求标志

当中断信号出现时，单片机中某些寄存器位（中断请求标志位）可被硬件置1。

CPU通过定期查看中断请求标志位是否为1，便可知道有无中断请求。

| 中断源名称 | 中断请求标志与取值 |
| ---------- | ------------------ |
| INT0       | IE0=1              |
| T0         | TF0=1              |
| INT1       | IE1=1              |
| T1         | TF1=1              |
| TI/RI      | TI=1/RI=1          |



## 寄存器

与中断有关的特殊功能寄存器一共有4个。

1. 定时/计数器控制寄存器(`TCON`)
2. 串行口控制寄存器(`SCON`)
3. 中断允许控制寄存器(`IE`)
4. 中断优先级控制寄存器(`IP`)

### TCON寄存器

定时/计数器的控制寄存器（Timer/Counter Control Register），字节地址为88H，可位寻址。

| 位7(8FH)       | 位6(8EH) | 位5(8DH)       | 位4(8CH) | 位3(8BH)       | 位2(8AH)         | 位1(89H)         | 位0(88H)         |
| -------------- | -------- | -------------- | -------- | -------------- | ---------------- | ---------------- | ---------------- |
| TF1            | TR1      | TF0            | TR0      | IE1            | IT1              | IE0              | IT0              |
| T1中断请求标志 |          | T0中断请求标志 |          | INT1断请求标志 | INT1中断触发信号 | INT0中断请求标志 | INT0中断触发信号 |

IT0（TCON.0），外部中断0触发方式控制位。

* 当IT0=0时，为低电平触发方式。
* 当IT0=1时，为边沿触发方式（下降沿有效）。

IE0（TCON.1），外部中断0中断请求标志位。

IT1（TCON.2），外部中断1触发方式控制位。

IE1（TCON.3），外部中断1中断请求标志位。

TF0（TCON.5），定时/计数器T0溢出中断请求标志位。

TF1（TCON.7），定时/计数器T1溢出中断请求标志位。

**注意:** 51单片机复位后，TCON初值为0——默认没有上述中断请求，默认采用电平触发方式。



### SCON寄存器

串口控制寄存器(Serial control register)，字节地址为98H，可位寻址。

| 位7  | 位6  | 位5  | 位4  | 位3  | 位2  | 位1(99H)         | 位0(98H)         |
| ---- | ---- | ---- | ---- | ---- | ---- | ---------------- | ---------------- |
|      |      |      |      |      |      | TI               | RI               |
|      |      |      |      |      |      | TX的中断请求标志 | RX的中断请求标志 |

**注意:** TI和RI虽然是2个中断请求标志位，但在SCON之后经或门电路合成为1个信息，统一接受中断管理。



### IE寄存器

中断允许寄存器（Interrupt Enable Register），字节地址为A8H，可位寻址。

| 位            | 位7  | 位6  | 位5  | 位4  | 位3  | 位2  | 位1  | 位0  |
| ------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 字节地址：A8H | EA   |      |      | ES   | ET1  | EX1  | ET0  | EX0  |

EA：中断允许总开关控制位。（1：所有中断请求被允许；0：所有中断请求被屏蔽）

ES：串行口中断允许控制位。（1：允许串口中断；0：禁止串口中断）

ET1：定时器/计数器T1的溢出中断允许控制位。（1：允许T1溢出中断；0：禁止T1溢出中断）

EX1：外部中断1中断允许位。（1：允许外部中断1中断；0：禁止外部中断1中断）

ET0：定时器/计数器T0的溢出中断允许控制位。（1：允许T1溢出中断；0：禁止T1溢出中断）

EX0：外部中断0中断允许位。（1：允许外部中断1中断；0：禁止外部中断1中断）

**注意:** 禁止中断并不能阻止中断请求标志值的硬件刷新；



### IP寄存器

中断优先级寄存器（Interrupt Priority Registers），字节地址为B8H，可位寻址。

| 位7  | 位6  | 位5  | 位4(BCH)               | 位3(BBH)           | 位2(BAH)                  | 位1(B9H)           | 位0(B8H)                  |
| ---- | ---- | ---- | ---------------------- | ------------------ | ------------------------- | ------------------ | ------------------------- |
|      |      |      | PS                     | PT1                | PX1                       | PT0                | PX0                       |
|      |      |      | 串行口中断优先级控制位 | T1中断优先级控制位 | 外部中断1中断优先级控制位 | T0中断优先级控制位 | 外部中断0中断优先级控制位 |

`PS=1`，串行口中断为高优先级；`PS=0`，为低优先级。

`PT1=0`，T1溢出中断为低优先级；当`PT1=1`时，T1溢出中断为高优先级。

`PT0=0`，T0溢出中断为低优先级；当`PT0=1`时，T0溢出中断为高优先级。

`PX1=0`，外部中断1为低优先级；当`PX1=1`时，外部中断1为高优先级。

`PX0=0`，外部中断0为低优先级；当`PX0=1`时，外部中断0为高优先级。



## 中断处理过程

关键字：`interrupt`

````c
返回值 函数名() interrupt 中断号{ //中断号必须与规定的中断号一致
    
}
````



**中断响应条件：**

1. 中断源有中断请求

2. 此中断源的中断允许位为1

3. CPU开中断（即EA=1）

以上三条同时满足时，CPU才有可能响应中断。

**例：**以外部中断0为例

````c
EA=1；//打开总中断开关
EX0=1；//开外部中断0
IT0=0/1；//设置外部中断的触发方式
````

**代码:** 利用中断控制LED闪烁形式

````c
#include "reg52.h"
#include "intrins.h"
typedef	unsigned char u8;
typedef unsigned int u32;

sbit LED=P0^0;
sbit KEY3=P3^2;
void delay(u32 i){
	while(i--);
}
void Int0() interrupt 0 {
	 delay(1000);//按键消抖
	 if(KEY3 == 0 ){
	 	LED=~LED;
	 }
}
void Int0Init(void){
	/* IE寄存器*/
	EA  = 1; //CPU中断允许（总允许）位
	EX0 = 1; //外部中断0允许位
	/* TCON寄存器*/
	IT0 = 1; //外部中断0触发方式控制位
} 
int main( void ){
	LED=0;
	Int0Init();
	while(1){	     
	}
	return 0;
}
````





# 定时器

## 周期

**时钟周期（振荡周期）**

* 时钟频率的倒数，单片机外接晶振的倒数。12MHz——>1/12us。
* 单片机中最基本、最小的时间单位。
* 一个时钟周期仅完成一个最基本的动作。
* 时钟脉冲是CPU基本工作脉冲，控制着CPU的工作节奏
* 时钟频率越高，单片机工作速度越快

**状态周期**

* 1状态周期 = 2时钟周期

**机器周期**

* 单片机基本操作周期，一个操作周期完成一项基本操作，取指令、储存器读写
* 1机器周期 = 6状态周期 = 12时钟周期

**指令周期**

* CPU执行一条指令的时间
* 1指令周期 = 1~4 机器周期

`1s=1000ms`

`1ms=1000us`



## 原理

定时/计数器的实质是加 1 计数器（16 位），由高8位和低 8 位两 个寄存器 THx 和 TLx 组成。它随着计数器的输入脉冲进行自加 1，也就是每来一个脉冲，计数器就自动加 1，当加到计数器为全1时，再输入一个脉冲就使计数 器回零，且计数器的溢出使相应的中断标志位置 1，向 CPU 发出中断请求（定时/计数器中断允许时）
    



## 寄存器

T0:端口P3.4

T1:端口P3.5



### TCOM

定时/计数器的控制寄存器（Timer/Counter Control Register），字节地址为88H，可位寻址。

| 位7(8FH)       | 位6(8EH)          | 位5(8DH)       | 位4(8CH)          | 位3(8BH)       | 位2(8AH)         | 位1(89H)         | 位0(88H)         |
| -------------- | ----------------- | -------------- | ----------------- | -------------- | ---------------- | ---------------- | ---------------- |
| TF1            | TR1               | TF0            | TR0               | IE1            | IT1              | IE0              | IT0              |
| T1中断请求标志 | 定时器1运行控制位 | T0中断请求标志 | 定时器0运行控制位 | INT1断请求标志 | INT1中断触发信号 | INT0中断请求标志 | INT0中断触发信号 |

TF1/TF0 计数溢出标志位：由CPU控制

TR1/TR0计数运行控制为：

* 0:关闭定时计数器
* 1：开启定时计数器



### TMOD

该寄存器的功能是设置定时器/计数器中断的工作方式。如设置定时器模式、计数位的位数。总共8位，前四位和后四位分别对应T1和T0。不可位寻址

| 位7(8FH) | 位6(8EH) | 位5(8DH) | 位4(8CH) | 位3(8BH) | 位2(8AH) | 位1(89H) | 位0(88H) |
| -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| GATE     | C/T      | M1       | M0       | GATE     | C/T      | M1       | M0       |

* GATE:门控位，GATE=0时，用于控制定时器的启动是否受外部中断源信号的影响，只要用软件使TCON中的TR0或者TR1为1，就可以启动定时器；而当GATE=1时，要用软件使TCON中的TR0或者TR1为1，同时外部中断INT0/1也为高电平，才能启动定时器。
* C/T:定时/计数模式选择位。C/T=0时，为定时模式；C/T=1时，为计数模式；
* M1M0:为工作方式设置位。

| M1M0 | 工作方式 | 说明                           |
| ---- | -------- | ------------------------------ |
| 00   | 方式0    | 13位定时/计数器                |
| 01   | 方式1    | 16位定时/计数器                |
| 10   | 方式2    | 8位自动重装定时/计数器         |
| 11   | 方式3    | T0分为两个独立的8位定时/计数器 |



**方式0**

方式0为13位计数，由TL0的低5位和TH0的8位组成。TL0的低5位溢出时向TH0进位，TH0溢出时，置位TCON中的TF0标志，向 CPU发出中断请求。

计算：`(8182-X)*12/晶振频率` 求`X`的值，将二进制X值的低五位转换成十六进制赋值给TL，高八位赋值给TH

![image-20221028191238335](单片机.assets/image-20221028191238335.png)

分析：

1. GATE=0 经过非门置为1,1>=1 A线路为1 或 GATE=0,INT1=1

2. TR1=1，与线路A并运算，线路A=1 & TR1 = 1，B线路为1，控制端关闭
3. C/T选择计数或计数模式



**方式1**

方式1的计数位数是16位，由TL0作为低8位，TH0作为高8位，组成了16位加1计数器

计算：`(65536-X)*12/晶振频率` 求`X`的值，将低八位赋值给TL，高八位赋值给TH

![image-20221028191841614](单片机.assets/image-20221028191841614.png)



**方式2**

方式2为自动重装初值的8位计数方式。工作方式2特别适合于用作较精确的脉冲信号发生器

计算：`(256-X)*12/晶振频率` 求`X`的值，TH与TL赋值相同，即将X的16进制赋值给TH、TL

![image-20221028191902096](单片机.assets/image-20221028191902096.png)

> 例：T0使用计算功能，使用方式2，则TMOD=0X02;
>
> ​	即：GATE=0,C/T=0,M1=1,M0=0



**方式3**

方式3只适用于定时/计数器T0，定时器T1处于方式3时相当于TR1=0，停止计数。工作方式3将T0分成为两个独立的8位计数器 TL0和TH0 。

![image-20221028191921207](单片机.assets/image-20221028191921207.png)





### 定时器初值寄存器 THx/TLx

TH0代表定时器的高八位(High)，TL0是定时器的低八位(LOW)，TH0和TL0两个8位即组成16位定时器；同理，TH1和TL1也是这个意义。这两个寄存器存放单片机定时器中断的数值边界，当超出边界后，会有中断产生。

公式:`(总值-X)*12/晶振频率` 求`X`的值

> 例：10MS定时器初值的计算：

1. 晶振12M：12MHz除12为1MHz，也就是说一秒=1000000次机器周期。10ms=10000次 机器周期。`65536-10000=55536(d8f0)`，TH0=0xd8，TL0=0xf0；(`TH0=55536/256,TL0=55536%256`)

2. 晶振11.0592M：11.0592MHz除12为921600Hz，就是一秒921600次机器周期，10ms=9216次机器周期。`65536-9216=56320(dc00)`，TH0=0xdc，TL0=0x00。

````c
void Timer0Init() { 
   TMOD=0X01;//选择为定时器0模式，工作方式1，仅用TR0打开启动。 
   
    //给定时器赋初值
   TH0=0xd8;  
   TL0=0xf0; 
   
   EA=1;//打开总中断 
   ET0=1;//打开定时器0中断允许 
   TR0=1;//打开定时器 
}
````



例：

````c
//第一个led灯以500ms一次的频率闪烁
void timer1_init()//初始化
{
	TMOD = 0x10; //定时器0选择工作方式1
    TH1 = 0x4C;	 //设置初始值，定时50ms
    TL1 = 0x00; 
    EA = 1;			 //打开总中断
    ET1 = 1;		 //打开定时器0中断
    TR1 = 1;		 //启动定时器0
}
void main()
{
    int i = 0;
	led = 1;
	timer1_init();//定时器1的初始化
	while(1)
	{
		if(i==10)       //i==10时，10 * 50ms = 500ms
		{
		  led = ~led;
		  i = 0; //注意i需要零
		}
	}
}

//每进入一次定时中断函数i+1
void timer1() interrupt 3  //中断服务函数
{
    TH1 = 0x4C;	 //设置初始值，定时50ms，这里晶振用12
    TL1 = 0x00;
	i++;
}
````

